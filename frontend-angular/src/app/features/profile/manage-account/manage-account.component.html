<div class="space-y-6">
    <div class="flex flex-col items-center justify-center py-6 animate-in fade-in slide-in-from-top-4 duration-700">
        <h1
            class="text-4xl font-display font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-600 to-electric-purple dark:from-sky-blue dark:to-electric-purple mb-2">
            Profile</h1>
        <p class="text-gray-500 dark:text-gray-400 max-w-2xl text-center">Manage your account settings and preferences
        </p>
    </div>

    <!-- User Info -->
    <div class="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-sm p-6">
        <div class="flex items-start md:items-center justify-between flex-col md:flex-row gap-6">
            <div class="flex items-center space-x-4">
                <div class="relative group">
                    <div
                        class="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center overflow-hidden border-2 border-white dark:border-gray-800 shadow-md">
                        @if (photoPreview) {
                        <img [src]="photoPreview" alt="Profile" class="w-full h-full object-cover">
                        } @else {
                        <ng-icon name="lucideUser" class="text-white text-3xl"></ng-icon>
                        }
                    </div>
                    <label
                        class="absolute bottom-0 right-0 bg-white dark:bg-gray-700 p-1.5 rounded-full shadow-sm cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors border border-gray-200 dark:border-gray-600">
                        <ng-icon name="lucideUpload" class="text-gray-600 dark:text-gray-300" size="14"></ng-icon>
                        <input type="file" class="hidden" accept="image/*" (change)="handlePhotoChange($event)">
                    </label>
                </div>
                <div>
                    <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">{{ user?.name }}</h2>
                    <p class="text-gray-600 dark:text-gray-400">{{ user?.email }}</p>
                    <div class="flex items-center gap-2 mt-2">
                        <span
                            class="inline-block px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-sm rounded">
                            {{ user?.role }}
                        </span>
                        @if (photoFile) {
                        <button (click)="handleSavePhoto()"
                            class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded transition-colors animate-in fade-in">
                            Save Photo
                        </button>
                        }
                        @if (user?.profilePhoto && !photoFile) {
                        <button (click)="handleDeletePhoto()"
                            class="text-xs bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded transition-colors animate-in fade-in">
                            Delete Photo
                        </button>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Information Section -->
    <div class="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-sm p-6">
        <div class="flex items-center space-x-2 mb-6">
            <ng-icon name="lucideUser" class="text-gray-600 dark:text-gray-400" size="20"></ng-icon>
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Profile Information</h2>
        </div>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Display Name
                </label>
                <div class="flex gap-4">
                    <input type="text" [(ngModel)]="displayName"
                        class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                        placeholder="Your display name">
                    <button (click)="handleSaveName()"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors whitespace-nowrap">
                        Save Name
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bio Section -->
    <div class="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-sm p-6">
        <div class="flex items-center space-x-2 mb-6">
            <ng-icon name="lucideUser" class="text-gray-600 dark:text-gray-400" size="20"></ng-icon>
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Bio</h2>
        </div>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    About You
                </label>
                <textarea [(ngModel)]="bio"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white h-32 resize-none"
                    placeholder="Tell us a little about yourself..."></textarea>
            </div>
            <button (click)="handleSaveBio()"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors">
                Save Bio
            </button>
        </div>
    </div>

    <!-- Change Password -->
    <div class="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-sm p-6">
        <div class="flex items-center space-x-2 mb-6">
            <ng-icon name="lucideLock" class="text-gray-600 dark:text-gray-400" size="20"></ng-icon>
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Change Password</h2>
        </div>

        <form (ngSubmit)="handleChangePassword()" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Current Password
                </label>
                <input type="password" [(ngModel)]="oldPassword" name="oldPassword" required
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                    placeholder="Enter current password">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    New Password
                </label>
                <input type="password" [(ngModel)]="newPassword" name="newPassword" required minlength="6"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                    placeholder="Enter new password">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Confirm New Password
                </label>
                <input type="password" [(ngModel)]="confirmPassword" name="confirmPassword" required minlength="6"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                    placeholder="Confirm new password">
            </div>

            <button type="submit" [disabled]="loading"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors disabled:opacity-50">
                {{ loading ? 'Changing...' : 'Change Password' }}
            </button>
        </form>
    </div>

    <!-- Two-Factor Authentication -->
    <div class="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-sm p-6">
        <div class="flex items-center space-x-2 mb-6">
            <ng-icon name="lucideShield" class="text-gray-600 dark:text-gray-400" size="20"></ng-icon>
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Two-Factor Authentication</h2>
        </div>

        <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
            @if (isEnabled) {
            <div
                class="flex items-center text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                <ng-icon name="lucideShield" class="h-5 w-5 mr-3"></ng-icon>
                <span class="font-medium">Two-Factor Authentication is enabled on your account.</span>
            </div>
            } @else {
            <div>
                @if (!isSetupOpen) {
                <div>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">
                        Add an extra layer of security to your account by enabling two-factor authentication.
                    </p>
                    <button (click)="handleStartSetup()"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Enable 2FA
                    </button>
                </div>
                } @else {
                <div class="space-y-6">
                    <div>
                        <p class="text-gray-700 dark:text-gray-300 text-sm mb-2 font-medium">
                            1. Scan this QR Code with your authenticator app (Google Authenticator, Authy, etc).
                        </p>
                        <div class="bg-white p-4 inline-block rounded-lg border border-gray-200">
                            <qrcode [qrdata]="setupUri" [width]="180" [errorCorrectionLevel]="'M'"></qrcode>
                            <!-- <p class="text-black">QR Code: {{ setupUri }}</p> -->
                        </div>
                    </div>

                    <div>
                        <p class="text-gray-700 dark:text-gray-300 text-sm mb-2 font-medium">
                            2. Enter the 6-digit code from your app below.
                        </p>
                        <form (ngSubmit)="handleEnable2FA()" class="flex gap-4 max-w-xs">
                            <input type="text" [(ngModel)]="otpCode" name="otpCode" placeholder="000000" maxlength="6"
                                required
                                class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white text-center tracking-widest">
                            <button type="submit"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                Verify
                            </button>
                        </form>
                    </div>
                </div>
                }
            </div>
            }
        </div>
    </div>

    <!-- Domain Verification Section -->
    <div class="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg shadow-sm p-6">
        <div class="flex items-center space-x-2 mb-6">
            <ng-icon name="lucideGlobe" class="text-gray-600 dark:text-gray-400" size="20"></ng-icon>
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Domain Verification</h2>
        </div>

        <p class="text-gray-600 dark:text-gray-400 mb-6">
            Verify domain ownership to access advanced scanning features (e.g., Nmap -sS).
            Upload a certificate file (TXT, Image) to prove ownership.
        </p>

        <form (ngSubmit)="handleUploadDomain()"
            class="mb-8 p-4 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-lg">
            <h3 class="text-md font-medium text-gray-900 dark:text-white mb-4">Add New Domain</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Domain Name (e.g., example.com)
                    </label>
                    <input type="text" [(ngModel)]="domainName" name="domainName"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                        placeholder="example.com" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Proof File (Image or TXT)
                    </label>
                    <input type="file" (change)="onFileSelected($event)"
                        class="w-full text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-gray-700 dark:file:text-white"
                        required>
                </div>
                <div class="flex items-end">
                    <button type="submit"
                        class="w-full flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <ng-icon name="lucideUpload" class="mr-2" size="16"></ng-icon>
                        Submit for Verification
                    </button>
                </div>
            </div>
        </form>

        <h3 class="text-md font-medium text-gray-900 dark:text-white mb-4">Your Domains</h3>
        @if (domains.length === 0) {
        <p class="text-gray-500 italic">No domains submitted yet.</p>
        } @else {
        <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
            <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-800">
                <thead class="bg-gray-50 dark:bg-gray-900">
                    <tr>
                        <th scope="col"
                            class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 dark:text-white">
                            Domain</th>
                        <th scope="col"
                            class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-white">Uploaded
                            At</th>
                        <th scope="col"
                            class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-white">Status
                        </th>
                        <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                            <span class="sr-only">Details</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-800 bg-white dark:bg-black">
                    @for (domain of domains; track domain.id) {
                    <tr>
                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 dark:text-white">
                            {{ domain.domainName }}
                        </td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-300">
                            {{ domain.createdAt | date }}
                        </td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm">
                            <span [class]="'inline-flex rounded-full px-2 text-xs font-semibold leading-5 ' + (domain.status === 'Verified' ? 'bg-green-100 text-green-800' :
                    domain.status === 'Rejected' ? 'bg-red-100 text-red-800' :
                      'bg-yellow-100 text-yellow-800')">
                                @if (domain.status === 'Verified') { <ng-icon name="lucideCircleCheck"
                                    class="mr-1 mt-0.5" size="14"></ng-icon> }
                                @if (domain.status === 'Rejected') { <ng-icon name="lucideCircleX" class="mr-1 mt-0.5"
                                    size="14"></ng-icon> }
                                @if (domain.status === 'Pending') { <ng-icon name="lucideClock" class="mr-1 mt-0.5"
                                    size="14"></ng-icon> }
                                {{ domain.status }}
                            </span>
                        </td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-300">
                            @if (domain.adminComments) {
                            <span class="text-xs italic text-gray-400">Note: {{ domain.adminComments }}</span>
                            }
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
        }
    </div>

    <!-- Delete Account Section -->
    @if (user?.role !== 'Admin') {
    <div class="bg-white dark:bg-black border border-red-200 dark:border-red-900/30 rounded-lg shadow-sm p-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-xl font-semibold text-red-600 dark:text-red-500">Delete Account</h2>
                <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">
                    Permanently delete your account and all associated data. This action cannot be undone.
                </p>
            </div>
            <button (click)="handleDeleteAccount()"
                class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors">
                Delete Account
            </button>
        </div>
    </div>
    }
</div>